on:
  workflow_call:
    inputs:
      hasCodeChanged:
        required: true
        type: boolean
      isTag:
        required: true
        type: boolean
      BUILD_AWS_ACCESS_KEY_ID:
        type: string
        required: true
      BUILD_AWS_SECRET_ACCESS_KEY:
        required: true

defaults:
  run:
    working-directory: packages/php-table-backend-utils

jobs:
  build_php_table_backend_utils:
    if: ${{ inputs.hasCodeChanged || inputs.isTag }}
    runs-on: ${{ matrix.operating-system }}
    strategy:
      matrix:
        operating-system: [ 'ubuntu-latest' ]
        php-versions: [ '7.4','8.0','8.1' ]
        phpunit-versions: [ 'latest' ]
    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
      -
        name: Build docker image
        env:
          AWS_ACCESS_KEY_ID: ${{ inputs.BUILD_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BUILD_AWS_SECRET_ACCESS_KEY }}
        run: |
          docker-compose build production
          docker save -o /tmp/php-table-backend-utils.tar table-utils:latest
      -
        name: Check
        run: |
          docker-compose run production composer check